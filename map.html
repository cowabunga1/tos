<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="chrome=1">
		<title>Дворы</title>

		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

	</head>
	<body>

		<div id="map" style="width: 1200px; height: 900px"></div>


		<script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU" type="text/javascript"></script>


		<script type="text/javascript" src="tos_db.js"></script>
		<script type="text/javascript" src="tos_courtyard_db.js"></script>
		<script type="text/javascript">

			ymaps.ready(make_map);
			var myMap;
			var factory_mark;

			function make_map() {

				myMap = new ymaps.Map("map", {
					center: [55.12177266, 36.61659852],
					zoom: 16,
					type: 'yandex#publicMap'
				});


				for( var i=0; i < tos_objects.length; i++ ) {
					var house = tos_objects[i];
					
					var houseName 			= house.yandex_api_data.name;
					var houseDescription 	= house.yandex_api_data.description;
					var houseApartments 	= ( house.apartments != 0 ) ? house.apartments : 'неизвестно';
					var entrances			= ( house.entrances != 0 ) ? house.entrances : 'неизвестно';
					var floors				= ( house.floors != 0 ) ? house.floors : 'неизвестно';
					var housePoint 			= house.yandex_api_data.Point.pos.split( ' ' );

					var hintContent = houseName + '  (Квартир: '+ houseApartments + ')';
					var body_html = '';
					
					body_html += '<p>';
					body_html += 'Расположение: ' + houseDescription;
					body_html += '</p>';

					body_html += '<p>';
					body_html += '<b>Квартиры: </b>' + houseApartments;
					body_html += '<br><b>Подъезды: </b>' + entrances;
					body_html += '<br><b>Этажи: </b>' + floors;
					body_html += '</p>';

					var houseMark = new ymaps.Placemark( [housePoint[1], housePoint[0]], { 
						iconContent: houseApartments,
						hintContent: hintContent,
						balloonContentHeader: houseName,
						balloonContentBody: body_html
					}, {
						 preset: "islands#blueStretchyIcon"
					});
					myMap.geoObjects.add( houseMark );

				};

				for( var j=0; j < tos_courtyard_objects.length; j++ ) {
					var courtyard = tos_courtyard_objects[j];

					var courtyardPolygon 	= courtyard.Polygon;
					var courtyardName 		= courtyard.name;
					var courtyardHouses 	= courtyard.houses;
					var total_apartments	= 0;

					var infrastructure = courtyard.infrastructure;
					//console.log( infrastructure );

					var playground 	= infrastructure.playground ? 'да' : 'нет';
					var workout 	= infrastructure.workout ? 'да' : 'нет';
					var basketball 	= infrastructure.basketball ? 'да' : 'нет';
					var footbal 	= infrastructure.footbal ? 'да' : 'нет';
					var hokkey 		= infrastructure.hokkey ? 'да' : 'нет';
					var pingpong 	= infrastructure.pingpong ? 'да' : 'нет';

					// var houseDescription = house.yandex_api_data.description;
					// var houseApartments = house.apartments;
					// var housePoint = house.yandex_api_data.Point.pos.split( ' ' );

					// var hintContent = houseName + '  (Квартир: '+ houseApartments + ')';
					var body_html = '';
					
					body_html += '<h3>Жилой фонд</h3>';

					body_html += '<p>';
					for( var k=0; k < courtyardHouses.length; k++ ) {
						var cyHouse = courtyardHouses[k];
						total_apartments += cyHouse.apartments;
						body_html += cyHouse.name + ': <b>' + cyHouse.apartments + '</b><br>';
					}
					body_html += '<b>Всего: ' + total_apartments + ' квартир</b>';
					body_html += '</p>';
					body_html += '<h3>Инфрастуктура</h3>';
					body_html += '<p>';
					body_html += '<b>Детская площадка:	</b>' + playground;
					body_html += '<br><b>Турники:	</b>' + workout;
					body_html += '<br><b>Баскетбольная площадка:	</b>' + basketball;
					body_html += '<br><b>Футбольное поле:	</b>' + footbal;
					body_html += '<br><b>Хоккейный корт:	</b>' + hokkey;
					body_html += '<br><b>Теннисные столы:	</b>' + pingpong;
					body_html += '</p>';
					body_html += '<h3>Парковочные места</h3>';
					body_html += '<p>';
					body_html += '<b>Всего: неизветстно</b>';
					body_html += '</p>';

					var courtyardPolygon = new ymaps.Polygon([
						// Указываем координаты вершин многоугольника.
						// Координаты вершин внешнего контура.
						courtyardPolygon
					], {
						// Описываем свойства геообъекта.
						// Содержимое балуна.
						hintContent: courtyardName,
						
						balloonContentHeader: courtyardName,
						balloonContentBody: body_html
			
					}, {
						// Задаем опции геообъекта.
						// Цвет заливки.
						fillColor: '#00FF0088',
						fillOpacity: 0.4,
						// Ширина обводки.
						strokeWidth: 5,

						balloonMaxHeight: 600
						//balloonPanelMaxMapArea: 0
						// draggable: true
					});

					myMap.geoObjects.add( courtyardPolygon);

					// courtyardPolygon.editor.startEditing();

					
					// courtyardPolygon.editor.events.add("vertexdragend", getCoordinates);
					// courtyardPolygon.editor.events.add("edgedragend", getCoordinates);

				};

					

			};

			function getCoordinates (event) {
				console.log('New coordinates:');

				var myPoint = event.get("target");
				var coor = myPoint.geometry.getCoordinates();

				console.log( JSON.stringify(coor) );
			}


		</script>


	</body>
</html>
